# pipelines/azure-pipelines.yml

trigger:
  - master

pool:
  name: "MyLaptopPool"

variables:
  # Senin bulduğun çalışan değerler:
  azureServiceConnection: "AzureConnection" # DevOps'ta oluşturacağımız bağlantı adı
  resourceGroupName: "MonitorApp-francecentral"
  location: "francecentral"
  functionAppName: "monitor-func-mn9146" # DİKKAT: Burayı güncellememiz gerek (Aşağıda anlatıyorum)
  # Build ayarları
  buildConfiguration: "Release"
  dotnetVersion: "8.0.x"

stages:
  # --------------------------------------------------------
  # STAGE 1: BUILD (CI)
  # --------------------------------------------------------
  - stage: Build
    displayName: "Build Stage"
    jobs:
      - job: BuildJob
        displayName: "Build Function App"
        steps:
          - task: UseDotNet@2
            displayName: "Install .NET SDK"
            inputs:
              version: $(dotnetVersion)

          - task: DotNetCoreCLI@2
            displayName: "Restore"
            inputs:
              command: "restore"
              projects: "src/**/*.csproj"

          - task: DotNetCoreCLI@2
            displayName: "Build"
            inputs:
              command: "build"
              projects: "src/**/*.csproj"
              arguments: "--configuration $(buildConfiguration) --no-restore"

          - task: DotNetCoreCLI@2
            displayName: "Publish"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "src/**/*.csproj"
              arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/drop"
              zipAfterPublish: true

          # Bicep dosyalarını da artifact içine koyuyoruz
          - task: CopyFiles@2
            displayName: "Copy Bicep Files"
            inputs:
              SourceFolder: "infra"
              Contents: "**"
              TargetFolder: "$(Build.ArtifactStagingDirectory)/infra"

          - task: PublishBuildArtifacts@1
            displayName: "Publish Artifacts"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "drop"
              publishLocation: "Container"

  # --------------------------------------------------------
  # STAGE 2: DEPLOY (CD)
  # --------------------------------------------------------
  - stage: Deploy
    displayName: "Deploy Stage"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: "Deploy to Azure"
        environment: "Development"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureResourceManagerTemplateDeployment@3
                  displayName: "Deploy Infrastructure (Bicep)"
                  inputs:
                    deploymentScope: "Resource Group"
                    azureResourceManagerConnection: $(azureServiceConnection)
                    subscriptionId: "84dad420-6a1b-4b8e-b23c-fe599ce8de2c" # Senin Subscription ID'n
                    action: "Create Or Update Resource Group"
                    resourceGroupName: $(resourceGroupName)
                    location: $(location)
                    templateLocation: "Linked artifact"
                    csmFile: "$(Pipeline.Workspace)/drop/infra/main.bicep"
                    deploymentMode: "Incremental"

                # Bicep çıktısından Function App ismini alıyoruz (Dinamik olması için)
                - task: AzureCLI@2
                  displayName: "Get Function App Name"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "ps"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      $funcName = az deployment group show --resource-group $(resourceGroupName) --name main --query properties.outputs.functionAppName.value -o tsv
                      Write-Host "##vso[task.setvariable variable=functionAppName]$funcName"
                      Write-Host "Function App Name: $funcName"

                - task: AzureFunctionApp@1
                  displayName: "Deploy Function Code"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    appType: "functionAppLinux" # Linux seçmiştik
                    appName: $(functionAppName)
                    package: "$(Pipeline.Workspace)/drop/drop/*.zip"
